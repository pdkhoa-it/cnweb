@model NoiThat_v1._0.Models.DonHang

@{
    Layout = null;
}

<!--Nút mở Modal-->
<a class="btn btn-success m-3" data-toggle="modal" data-target="#DonHangModal">Thêm đơn hàng</a>
<a class="btn btn-warning" data-toggle="modal" data-target="#ImportModal">Import Excel</a>

<!-- Modal -->
<div class="modal fade" id="DonHangModal" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabel">Thêm đơn hàng</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="Refresh()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @using (Ajax.BeginForm("AddOrEdit", "DonHang", new AjaxOptions { HttpMethod = "POST", OnSuccess = "Success" }))
                {
                    @Html.Hidden("ID", "0")
                    <div class="form-group">
                        @Html.Editor("HoTen", new { htmlAttributes = new { @class = "form-control", @placeholder = "Họ tên khách hàng" } })
                        @Html.ValidationMessage("HoTen", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        @Html.Editor("Sdt", new { htmlAttributes = new { @class = "form-control", @type = "number", @placeholder = "Số điện thoại" } })
                        @Html.ValidationMessage("Sdt", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        @Html.Editor("Email", new { htmlAttributes = new { @class = "form-control", @type = "email", @placeholder = "Email" } })
                        @Html.ValidationMessage("Email", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        <select class="form-control" id="HinhThucThanhToan">
                            <option value="0">Thanh toán khi nhận hàng</option>
                            <option value="1">Chuyển khoản</option>
                        </select>
                    </div>
                    <div class="form-group">
                        @Html.Editor("ThoiGian", new { htmlAttributes = new { @class = "form-control", @placeholder = "Thời gian" } })
                        @Html.ValidationMessage("ThoiGian", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        @Html.Editor("DiaChiGiaoHang", new { htmlAttributes = new { @class = "form-control", @placeholder = "Địa chỉ giao hàng" } })
                        @Html.ValidationMessage("DiaChiGiaoHang", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        <input type="submit" class="btn btn-success float-right ml-3" id="btnSubmit" value="Submit" />
                        <input type="reset" class="btn btn-secondary float-right" value="Reset" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<table id="tableDH" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Khách hàng</th>
            <th>Số điện thoại</th>
            <th>Email</th>
            <th>Thời gian</th>
            <th>Địa chỉ</th>
            <th>Hình thức TT</th>
            <th>Tình trạng TT</th>
            <th>Tình trạng GH</th>
            <th>Tổng tiền</th>
            <th></th>
        </tr>
    </thead>
</table>

<!-- Modal import file Excel -->
<div class="modal fade" id="ImportModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nhập từ file Excel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @using (Ajax.BeginForm("Import", "SanPham", new AjaxOptions { HttpMethod = "POST", OnSuccess = "ImportSuccess" }, new { enctype = "multipart/form-data" }))
                {
                    <input type="file" class="form-control-file" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" name="excelfile" id="excelfile" />
                    <input type="submit" class="btn btn-success float-right ml-3" value="Nhập" />
                    <input type="button" data-dismiss="modal" class="btn btn-secondary float-right" value="Hủy" />
                }
            </div>
        </div>
    </div>
</div>

<script>
    var table;
    $.noConflict();
    $(document).ready(function () {

        $('#ThoiGian').datepicker({
            dateFormat: 'dd-mm-yy',
            changeMonth: true,
            changeYear: true,
            yearRange: "-1:+1"
        });

        table = $('#tableDH').DataTable({
            "ajax": {
                "url": "/DonHang/GetDanhSach",
                "type": "GET",
                "dataType": "json"
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6]
                    }
                },
                {
                    extend: 'pdfHtml5',
                    exportOptions: {
                        columns: [1, 2, 3, 4, 5, 6]
                    }
                },
                'colvis'
            ],
            "columns": [
                { "data": "HoTen" },
                { "data": "SDT" },
                { "data": "Email" },
                { "data": "ThoiGian" },
                { "data": "DiaChiGiaoHang" },
                {
                    "data": "HinhThucThanhToan", "render": function (n) {
                        if (n == 0)
                            return "Thanh toán khi nhận hàng";
                        else return "Chuyển khoản";
                    }
                },
                {
                    "data": "TinhTrangThanhToan", "render": function (t) {
                        if (t == 0)
                            return "Chờ thanh toán";
                        else return "Đã thanh toán";
                    }
                },
                {
                    "data": "TinhTrangGiaoHang", "render": function (g) {
                        if (g == 0)
                            return "Đang giao hàng";
                        else return "Đã giao hàng";
                    }
                },
                { "data": "TongTien" },
                {
                    "data": "ID", "render": function (id) {
                        return "<a class='btn btn-primary' onclick=BeginEdit('" + id + "') >Edit</a><a class='btn btn-danger' onclick=BeginDelete('" + id + "','/DonHang/Delete')>Delete</a>";
                    },
                    "orderable": false,
                    "searchable": false
                }],
            lengthMenu: [[5, 10, 20, 50, -1], [5, 10, 20, 50, "All"]]
        });
    });

    function BeginEdit(id) {
        var url = "/DonHang/BeginEdit";
        $.get(url, { id: id }).done(function (s) {
            $('#ID').val(s.ID);
            $('#Ten').val(s.Ten);
            $('#IDDanhMucSP').val(s.IDDM);
            $('#IDNCC').val(s.IDNCC);
            $('#MoTa').val(s.Mota);

            $('#ImgMess').html('Không chọn file nếu muốn giữ ảnh cũ.');

            $('#SanPhamModal').modal('show');

            $('#ModalLabel').html('Cập nhật thông tin');
        });
    }

    function Refresh() {
        $('#ID').val('0');
        $('#HoTen').val('');
        $('#Sdt').val('');
        $('#Email').val('');
        $('#ThoiGain').val('');
        $('#DiaChiGiaoHang').val('');
        $('#HoTen').val('0');

        $('#DonHangModal').modal('hide');

        $('#ModalLabel').html('Thêm đơn hàng');
    }

    function ImportSuccess(data) {
        if (data.success) {
            $('#mess').removeClass("alert-danger").addClass("alert-success");
            table.ajax.reload();
        }
        else $('#mess').removeClass("alert-success").addClass("alert-danger");

        $('#ImportModal').modal('hide');

        $('#mess').html(data.message);
        $('#toast').toast({ delay: 3000 });
        $('#toast').toast('show');
    }

</script>
