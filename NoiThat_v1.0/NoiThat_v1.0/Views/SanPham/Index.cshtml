@model NoiThat_v1._0.Models.SanPham

@{
    ViewBag.Title = "Index";
}

<!--Nút mở Modal-->
<a class="btn btn-success m-3" data-toggle="modal" data-target="#SanPhamModal">Thêm sản phẩm</a>

<!-- Modal -->
<div class="modal fade" id="SanPhamModal" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabel">Thêm sản phẩm</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="RefreshModal()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @using (Ajax.BeginForm("AddOrEdit", "SanPham", new AjaxOptions{ HttpMethod = "POST", OnSuccess = "Success"}, new {enctype = "multipart/form-data"}))
                {
                    @Html.Hidden("ID", "0")
                    <div class="form-group">
                        @Html.Editor("Ten", new { htmlAttributes = new { @class = "form-control", @placeholder = "Tên sản phẩm" } })
                        @Html.ValidationMessage("Ten", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        <input type="file" class="form-control-file" accept="*.jpeg, *.png, *.jpg" name="ImgUpload" id="ImgUpload">
                        <label class="col-form-label text-danger" id="ImgMess">Nếu không chọn file sẽ hiển thị ảnh mặc định!</label>
                    </div>
                    <div class="form-group">
                        @Html.DropDownList("IDDanhMucSP", ViewBag.listDM as SelectList, "Chọn danh mục sản phẩm", new { @class = "form-control" })
                        @Html.ValidationMessage("IDDanhMucSP", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        @Html.DropDownList("IDNCC", ViewBag.listNCC as SelectList, "Chọn nhà cung cấp", new { @class = "form-control" })
                        @Html.ValidationMessage("IDNCC", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        @Html.Editor("MoTa", new { htmlAttributes = new { @class = "form-control", @placeholder = "Mô tả sản phẩm" } })
                        @Html.ValidationMessage("MoTa", "", new { @class = "text-danger" })
                    </div>
                    <div class="form-group">
                        <input type="submit" class="btn btn-success float-right ml-3" id="btnSubmit" value="Submit" />
                        <input type="reset" class="btn btn-secondary float-right" value="Reset" />
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<table id="tableSP" class="table table-striped table-bordered" style="width:100%">
    <thead>
        <tr>
            <th>Ảnh</th>
            <th>Tên sản phẩm</th>
            <th>Danh mục</th>
            <th>Nhóm</th>
            <th>Nhà cung cấp</th>
            <th></th>
        </tr>
    </thead>
</table>

<script>
    var table;
    $.noConflict();
    $(document).ready(function () {

        table = $('#tableSP').DataTable({
            "ajax": {
                "url": "/SanPham/GetDanhSach",
                "type": "GET",
                "dataType": "json"
            },
            "columns": [
                {
                    "data": 'PathImg', "render": function (img) {
                        return '<img src = "https://localhost:44303'+img+'" height = "100px" />';
                    }
                },
                { "data": "Ten" },
                { "data": "TenDM" },
                { "data": "TenNhom" },
                { "data": "TenNCC" },
                {
                    "data": "ID", "render": function (id) {
                        return "<a class='btn btn-primary' onclick=BeginEdit('" + id + "') >Edit</a><a class='btn btn-danger' onclick=BeginDelete('" + id + "','/SanPham/Delete')>Delete</a>";
                    },
                    "orderable": false,
                    "searchable": false
                }],
            lengthMenu: [[5, 10, 20, 50, -1], [5, 10, 20, 50, "All"]]
        });
    });

    function BeginEdit(id) {
        var url = "/SanPham/BeginEdit";
        $.get(url, { id: id }).done(function (s) {
            $('#ID').val(s.ID);
            $('#Ten').val(s.Ten);
            $('#IDDanhMucSP').val(s.IDDM);
            $('#IDNCC').val(s.IDNCC);
            $('#MoTa').val(s.Mota);

            $('#ImgMess').html('Không chọn file nếu muốn giữ ảnh cũ.');

            $('#SanPhamModal').modal('show');
            
            $('#ModalLabel').html('Cập nhật thông tin');
        });
    }

    function my_success() {
        $('#SanPhamModal').modal('hide');
        RefreshModal();
    }

    function RefreshModal() {
        $('#ID').val('0');
        $('#Ten').val('');
        $('#IDDanhMucSP').val(null);
        $('#IDNCC').val(null);
        $('#MoTa').val('');

        $('#ImgMess').html('Nếu không chọn file sẽ hiển thị ảnh mặc định!');

        $('#SanPhamModal').modal('hide');

        $('#ModalLabel').html('Thêm sản phẩm');
    }
</script>